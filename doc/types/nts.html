<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>PostGIS/NetTopologySuite Type Plugin | Npgsql Documentation </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="PostGIS/NetTopologySuite Type Plugin | Npgsql Documentation ">
  
    <link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
    <link rel="manifest" href="../../site.webmanifest">
    <link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <link rel="stylesheet" href="../../styles/npgsql.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
  
  <meta property="docfx:rel" content="../../">
  
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">

        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="postgisnettopologysuite-type-plugin">PostGIS/NetTopologySuite Type Plugin</h1>

<p>PostgreSQL supports spatial data and operations via <a href="https://postgis.net/">the PostGIS extension</a>, which is a mature and feature-rich database spatial implementation. .NET doesn't provide a standard spatial library, but <a href="https://github.com/NetTopologySuite/NetTopologySuite">NetTopologySuite</a> is a leading spatial library. Npgsql has a plugin which allows you to map the NTS types PostGIS columns, and even translate many useful spatial operations to SQL. This is the recommended way to interact with spatial types in Npgsql.</p>
<p>PostgreSQL provides support for spatial types (geometry/geography) via the powerful <a href="https://postgis.net/">PostGIS</a> extension; this allows you to store points and other spatial constructs in the database, and efficiently perform operations and searches on them. Npgsql supports the PostGIS types via <a href="https://github.com/NetTopologySuite/NetTopologySuite">NetTopologySuite</a>, which is the leading spatial library in the .NET world: the NTS types can be read and written directly to their corresponding PostGIS types. This is the recommended way to work with spatial types in Npgsql.</p>
<h2 id="setup">Setup</h2>
<p>To avoid forcing a dependency on the NetTopologySuite library for users not using spatial, NTS support is delivered as a separate plugin. To use the plugin, simply add a dependency on <a href="https://www.nuget.org/packages/Npgsql.NetTopologySuite">Npgsql.NetTopologySuite</a> and set it up in one of the following ways:</p>
<div class="tabGroup" id="tabgroup_bHGHmlrG6S">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_bHGHmlrG6S_datasource" role="tab" aria-controls="tabpanel_bHGHmlrG6S_datasource" data-tab="datasource" tabindex="0" aria-selected="true">NpgsqlDataSource</a>
</li>
<li role="presentation">
<a href="#tabpanel_bHGHmlrG6S_global" role="tab" aria-controls="tabpanel_bHGHmlrG6S_global" data-tab="global" tabindex="-1">Global mapping</a>
</li>
<li role="presentation">
<a href="#tabpanel_bHGHmlrG6S_connection" role="tab" aria-controls="tabpanel_bHGHmlrG6S_connection" data-tab="connection" tabindex="-1">Connection mapping</a>
</li>
</ul>
<section id="tabpanel_bHGHmlrG6S_datasource" role="tabpanel" data-tab="datasource">

<div class="NOTE">
<h5>Note</h5>
<p><code>NpgsqlDataSource</code> was introduced in Npgsql 7.0, and is the recommended way to manage type mapping. If you're using an older version, see the other methods.</p>
</div>
<pre><code class="lang-c#">var dataSourceBuilder = new NpgsqlDataSourceBuilder(...);
dataSourceBuilder.UseNetTopologySuite();
await using var dataSource = dataSourceBuilder.Build();
</code></pre>
</section>
<section id="tabpanel_bHGHmlrG6S_global" role="tabpanel" data-tab="global" aria-hidden="true" hidden="hidden">

<p>If you're using an older version of Npgsql which doesn't yet support <code>NpgsqlDataSource</code>, you can configure mappings globally for all connections in your application:</p>
<pre><code class="lang-c#">NpgsqlConnection.GlobalTypeMapper.UseNetTopologySuite();
</code></pre>
<p>For this to work, you must place this code at the beginning of your application, before any other Npgsql API is called. Note that in Npgsql 7.0, global type mappings are obsolete (but still supported) - <code>NpgsqlDataSource</code> is the recommended way to manage type mappings.</p>
</section>
<section id="tabpanel_bHGHmlrG6S_connection" role="tabpanel" data-tab="connection" aria-hidden="true" hidden="hidden">

<div class="NOTE">
<h5>Note</h5>
<p>This mapping method has been removed in Npgsql 7.0.</p>
</div>
<p>Older versions of Npgsql supported configuring a type mapping on an individual connection, as follows:</p>
<pre><code class="lang-c#">var conn = new NpgsqlConnection(...);
conn.TypeMapper.UseNetTopologySuite();
</code></pre>
</section>
</div>

<p>By default the plugin handles only ordinates provided by the <code>DefaultCoordinateSequenceFactory</code> of <code>GeometryServiceProvider.Instance</code>. If <code>GeometryServiceProvider</code> is initialized automatically the X and Y ordinates are handled. To change the behavior specify the <code>handleOrdinates</code> parameter like in the following example:</p>
<pre><code class="lang-c#">dataSourceBuilder.UseNetTopologySuite(handleOrdinates: Ordinates.XYZ);
</code></pre>
<p>To process the M ordinate, you must initialize <code>GeometryServiceProvider.Instance</code> to a new <code>NtsGeometryServices</code> instance with <code>coordinateSequenceFactory</code> set to a <code>DotSpatialAffineCoordinateSequenceFactory</code>. Or you can specify the factory when calling <code>UseNetTopologySuite</code>.</p>
<pre><code class="lang-c#">// Place this at the beginning of your program to use the specified settings everywhere (recommended)
GeometryServiceProvider.Instance = new NtsGeometryServices(
    new DotSpatialAffineCoordinateSequenceFactory(Ordinates.XYM),
    new PrecisionModel(PrecisionModels.Floating),
    -1);

// Or specify settings for Npgsql only
dataSourceBuilder.UseNetTopologySuite.UseNetTopologySuite(
    new DotSpatialAffineCoordinateSequenceFactory(Ordinates.XYM));
</code></pre>
<h2 id="reading-and-writing-geometry-values">Reading and Writing Geometry Values</h2>
<p>When reading PostGIS values from the database, Npgsql will automatically return the appropriate NetTopologySuite types: <code>Point</code>, <code>LineString</code>, and so on. Npgsql will also automatically recognize NetTopologySuite's types in parameters, and will automatically send the corresponding PostGIS type to the database. The following code demonstrates a roundtrip of a NetTopologySuite <code>Point</code> to the database:</p>
<pre><code class="lang-c#">await conn.ExecuteNonQueryAsync(&quot;CREATE TEMP TABLE data (geom GEOMETRY)&quot;);

await using (var cmd = new NpgsqlCommand(&quot;INSERT INTO data (geom) VALUES ($1)&quot;, conn))
{
    cmd.Parameters.Add(new() { Value = new Point(new Coordinate(1d, 1d)) });
    await cmd.ExecuteNonQueryAsync();
}

await using (var cmd = new NpgsqlCommand(&quot;SELECT geom FROM data&quot;, conn))
await using (var reader = await cmd.ExecuteReaderAsync())
{
    await reader.ReadAsync();
    var point = reader.GetFieldValue&lt;Point&gt;(0);
}
</code></pre>
<p>You may also explicitly specify a parameter's type by setting <code>NpgsqlDbType.Geometry</code>.</p>
<h2 id="geography-geodetic-support">Geography (geodetic) Support</h2>
<p>PostGIS has two types: <code>geometry</code> (for Cartesian coordinates) and <code>geography</code> (for geodetic or spherical coordinates). You can read about the geometry/geography distinction <a href="https://postgis.net/docs/manual-2.4/using_postgis_dbmanagement.html#PostGIS_Geography">in the PostGIS docs</a> or in <a href="http://workshops.boundlessgeo.com/postgis-intro/geography.html">this blog post</a>. In a nutshell, <code>geography</code> is much more accurate when doing calculations over long distances, but is more expensive computationally and supports only a small subset of the spatial operations supported by <code>geometry</code>.</p>
<p>Npgsql uses the same NetTopologySuite types to represent both <code>geometry</code> and <code>geography</code> - the <code>Point</code> type represents a point in either Cartesian or geodetic space. You usually don't need to worry about this distinction because PostgreSQL will usually cast types back and forth as needed. However, it's worth noting that Npgsql sends Cartesian <code>geometry</code> by default, because that's the usual requirement. You have the option of telling Npgsql to send <code>geography</code> instead by specifying <code>NpgsqlDbType.Geography</code>:</p>
<pre><code class="lang-c#">await using (var cmd = new NpgsqlCommand(&quot;INSERT INTO data (geog) VALUES ($1)&quot;, conn))
{
    cmd.Parameters.Add(new() { Value = point, NpgsqlDbType = NpgsqlDbType.Geography });
    await cmd.ExecuteNonQueryAsync();
}
</code></pre>
<p>If you prefer to use <code>geography</code> everywhere by default, you can also specify that when setting up the plugin:</p>
<pre><code class="lang-c#">dataSourceBuilder.UseNetTopologySuite(geographyAsDefault: true);
</code></pre>
</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/npgsql/doc/blob/main/conceptual/Npgsql/types/nts.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      © Copyright 2023 The Npgsql Development Team
      
          </div>
        </div>
      </footer>
    </div>

    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
