<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Npgsql 8.0 Release Notes | Npgsql Documentation </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Npgsql 8.0 Release Notes | Npgsql Documentation ">
  
    <link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
    <link rel="manifest" href="../../site.webmanifest">
    <link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <link rel="stylesheet" href="../../styles/npgsql.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
  
  <meta property="docfx:rel" content="../../">
  
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">

        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="npgsql-80-release-notes">Npgsql 8.0 Release Notes</h1>

<p>Npgsql version 8.0 is out and available on <a href="https://www.nuget.org/packages/Npgsql/8.0.0">nuget.org</a>.</p>
<div class="NOTE">
<h5>Note</h5>
<p>Npgsql 8.0 will be the last version to support .NET Framework (via .NET Standard 2.0). Starting with 9.0, Npgsql will only target .NET TFMs supported at release time (i.e. <code>net6.0</code>).</p>
</div>
<h2 id="nativeaot-and-trimming-support">NativeAOT and trimming support</h2>
<p>Npgsql 8.0 now has 1st-class support for NativeAOT and trimming; the entire library has been properly annotated and is safe for use in applications. The majority of features have been made compatible with NativeAOT/trimming and can be used without issues, and most applications using Npgsql can be used as-is with NativeAOT/trimming without any changes. A few features which are incompatible require an explicit code opt-in, which generates a warning if used with NativeAOT/trimming enabled (<a href="#dynamic-optin">see breaking change note</a>).</p>
<p>Considerable effort has gone into reducing Npgsql's size footprint; a minimal Npgsql application using NativeAOT and trimming now takes only around 5MB of disk space. To allow users to achieve a minimal size footprint, <a class="xref" href="../api/Npgsql.NpgsqlSlimDataSourceBuilder.html">NpgsqlSlimDataSourceBuilder</a> has been introduced; unlike the standard <a class="xref" href="../api/Npgsql.NpgsqlDataSourceBuilder.html">NpgsqlDataSourceBuilder</a>, this builder includes only the very minimum of functionality by default, and allows adding additional features via opt-ins. This allows a pay-per-play approach to application size, where developers can choose only the features they actually need for optimal size. For more information, see <a class="xref" href="../api/Npgsql.NpgsqlSlimDataSourceBuilder.html">NpgsqlSlimDataSourceBuilder</a>.</p>
<p>Making Npgsql NativeAOT/trimming-compatible was a far-reaching effort, affecting many parts of the driver and involving a rewrite of large parts of Npgsql's internals (leading to many other internal improvements). This huge task was done mainly by <a href="http://github.com/ninofloris">Nino Floris</a>, with considerable contributions by <a href="https://github.com/vonzshik">Nikita Kazmin</a>.</p>
<h2 id="opentelemetry-metrics">OpenTelemetry metrics</h2>
<p>Npgsql has emitted metrics for several versions, which provided aggregated metrics on various Npgsql interals; for example, it was possible to follow the state of the connection pool, or to track how many commands are being executed per second. Npgsql 8.0 improves on that by switching from the older EventCounter API to the newer System.Diagnostics.Metrics API, implementing OpenTelemetry metrics. To understand more about the different kinds of metrics APIs in .NET, <a href="https://learn.microsoft.com/en-us/dotnet/core/diagnostics/compare-metric-apis">see these docs</a>.</p>
<p>The new metrics have several advantages over the old one; for one thing, they allow associating multiple <em>dimensions</em> to metrics, e.g. allowing Npgsql to cleanly emit pool-related metrics separately for each data source (or connection string) used in the application. The Npgsql metrics implement the experimental <a href="https://opentelemetry.io/docs/specs/semconv/database/database-metrics/">OpenTelemetry semantic conventions for database metrics</a> - adding some additional useful ones - and will evolve as that specification stabilizes.</p>
<p>For more information, see the <a href="../diagnostics/metrics.html">doc page on metrics</a>.</p>
<h2 id="register-npgsqldatasource-as-a-keyed-di-service">Register NpgsqlDataSource as a keyed DI service</h2>
<p>.NET 8.0 introduced <a href="https://learn.microsoft.com/dotnet/core/extensions/dependency-injection#keyed-services">keyed services for dependency injection</a>, allowing multiple services with the same CLR type to be registered in a single DI service provider. This is particularly useful when needing to contact multiple databases from your DI-enabled application:</p>
<pre><code class="lang-c#">var builder = WebApplication.CreateBuilder(args);

builder.Services
    .AddNpgsqlDataSource(&quot;Host=localhost;Database=CustomersDB;Username=test;Password=test&quot;, serviceKey: DatabaseType.CustomerDb)
    .AddNpgsqlDataSource(&quot;Host=localhost;Database=OrdersDB;Username=test;Password=test&quot;, serviceKey: DatabaseType.OrdersDb);

var app = builder.Build();

app.MapGet(&quot;/&quot;, async ([FromKeyedServices(DatabaseType.OrdersDb)] NpgsqlConnection connection)
    =&gt; connection.ConnectionString);

app.Run();

enum DatabaseType
{
    CustomerDb,
    OrdersDb
}
</code></pre>
<p>In this ASP.NET Minimal API application, two Npgsql data sources are registered in DI - one for a customers database, and another for an orders database. When a data source - or connections - needs to be injected somewhere, an enum is used as the service key, to distinguish which database is being requested (note that connections to both databases can be requested by the same function!).</p>
<p>For more information on registering Npgsql services in DI, see the documentation for <a href="https://www.nuget.org/packages/Npgsql.DependencyInjection#readme-body-tab">Npgsql.DependencyInjection</a>.</p>
<h2 id="other-features">Other features</h2>
<ul>
<li>Allow using nullable value types with the generic <code>NpgsqlParameter&lt;T&gt;</code>, e.g. <code>NpgsqlParameter&lt;int?&gt;</code>.</li>
<li>Introduce a non-caching password provider callback via &lt;xref:Npgsql.NpgsqlDataSourceBuilder.UsePasswordProvider?displayProperty=nameWithType&gt;.</li>
<li>Allow customizing System.Text.Json JsonSerializationOptions via &lt;xref:Npgsql.NpgsqlDataSourceBuilder.ConfigureJsonOptions?displayProperty=nameWithType&gt;.</li>
<li>Improvements and cleanup for networking type mappings:
<ul>
<li>In addition to .NET &lt;xref:System.Net.IPAddress&gt;, PostgreSQL <code>inet</code> can also mapped to be mapped to <a class="xref" href="../api/NpgsqlTypes.NpgsqlInet.html">NpgsqlInet</a>, which is an immutable struct containing both IP and netmask components.</li>
<li>PostgreSQL <code>cidr</code> is now mapped to the newly-introduced <a class="xref" href="../api/NpgsqlTypes.NpgsqlCidr.html">NpgsqlCidr</a>. The mapping to <code>ValueTuple&lt;IPAddress, int&gt;</code> has been removed.</li>
</ul>
</li>
<li>Allow providing the root certificate programmatically via the new &lt;xref:Npgsql.NpgsqlDataSourceBuilder.UseRootCertificate?displayProperty=nameWithType&gt;</li>
</ul>
<p>Version 8.0 contains many other smaller features and bug fixes, <a href="https://github.com/npgsql/npgsql/milestone/97?closed=1">see the 8.0.0 milestone</a> for the full list of issues.</p>
<h2 id="breaking-changes">Breaking changes</h2>
<h3 id="json-poco-and-other-dynamic-features-now-require-an-explicit-opt-in"><a name="dynamic-optin">JSON POCO and other dynamic features now require an explicit opt-in</a></h3>
<p>Npgsql 8.0 is fully compatible with NativeAOT and trimming (see above). While most driver capabilities have been made to work in those profiles, certain features involve dynamic coding practices and are incompatible with NativeAOT and/or trimming - at least for now. As a result, these features now require explicit opt-ins (annotated to be incompatible with NativeAOT/trimming), which you must add either on your <a class="xref" href="../api/Npgsql.NpgsqlDataSourceBuilder.html">NpgsqlDataSourceBuilder</a> or on <a class="xref" href="../api/Npgsql.NpgsqlConnection.html#Npgsql_NpgsqlConnection_GlobalTypeMapper">NpgsqlConnection.GlobalTypeMapper</a>:</p>
<table>
<thead>
<tr>
<th>PostgreSQL type</th>
<th>Default .NET type</th>
</tr>
</thead>
<tbody>
<tr>
<td>JSON POCO mapping, JsonNode and subtypes</td>
<td>&lt;xref:Npgsql.INpgsqlTypeMapperExtensions.EnableDynamicJson&gt;</td>
</tr>
<tr>
<td>Unmapped enums, ranges, multiranges</td>
<td>&lt;xref:Npgsql.INpgsqlTypeMapperExtensions.EnableUnmappedTypes&gt;</td>
</tr>
<tr>
<td>Read PostgreSQL records as .NET tuples</td>
<td>&lt;xref:Npgsql.INpgsqlTypeMapperExtensions.EnableRecordsAsTuples&gt;</td>
</tr>
</tbody>
</table>
<p>Existing code using the above features will start throwing exceptions after upgrading to Npgsql 8.0; the exceptions provide explicit guidance on how to add the opt-ins.</p>
<h3 id="ssl-moderequire-no-longer-validates-certificates"><code>SSL Mode=Require</code> no longer validates certificates</h3>
<p>tl;dr use <code>SSL Mode=VerifyCA</code> or <code>VerifyFull</code> in order to validate certificates provided by PostgreSQL.</p>
<p>In versions of Npgsql older than 6.0, specifying <code>SSL Mode=Require</code> made Npgsql validate the SSL/TLS certificate provided by PostgreSQL. This did not align with the meaning of &quot;require&quot; in PostgreSQL and other clients, where it simply means that SSL/TLS is required, but without certificate validation. To align with the standard PostgreSQL meaning, starting with Npgsql 6.0 <code>VerifyCA</code> or <code>VerifyFull</code> must be specified to validate the certificate.</p>
<p>To prevent existing usage of <code>Require</code> to silently stop validating, Npgsql 6.0 and 7.0 forced <code>Trust Server Certificate=true</code> to be specified; this made users aware of the change, guiding them to either switch to <code>VerifyCA</code>/<code>VerifyFull</code> (if they want validation) or to add <code>Trust Server Certificate=true</code> (if they don't). After two major versions, we are now removing the requirement to specify <code>Trust Server Certificate=true</code> with <code>SSL Mode=Require</code>; the latter will behave in the standard PostgreSQL way and will not verify certificates.</p>
<p>For more context, see <a href="https://github.com/npgsql/npgsql/issues/3988#issuecomment-933011009">#3988</a>.</p>
<h3 id="ilistt-mapping-now-requires-a-generic-npgsqlparametert">IList&lt;T&gt; mapping now requires a generic NpgsqlParameter&lt;T&gt;</h3>
<p>Previous versions of Npgsql allowed writing arbitrary list types as PostgreSQL array, as long as they implemented the <code>IList&lt;T&gt;</code> interface:</p>
<pre><code class="lang-c#">await using var command = new NpgsqlCommand(&quot;SELECT $1&quot;, conn)
{
    Parameters = { new NpgsqlParameter { Value = new ReadOnlyCollection&lt;int&gt;(new List&lt;int&gt; { 1, 2, 3 }) } }
};
await using var reader = await command.ExecuteReaderAsync();
</code></pre>
<p>This capability has been removed; supporting it required a costly reflection check, which also would be difficult to implement with trimming enabled, potentially increasing binary size in an unacceptable way. As a mitigation, you can instead use the generic <code>NpgsqlParameter&lt;T&gt;</code> - typed with <code>IList&lt;T&gt;</code> - to do the same:</p>
<pre><code class="lang-c#">await using var command = new NpgsqlCommand(&quot;SELECT $1&quot;, conn)
{
    Parameters = { new NpgsqlParameter&lt;IList&lt;int&gt;&gt; { Value = new ReadOnlyCollection&lt;int&gt;(new List&lt;int&gt; { 1, 2, 3 }) } }
};
await using var reader = await command.ExecuteReaderAsync();
</code></pre>
<h3 id="cidr-now-maps-to-npgsqlcidr-instead-of-valuetupleipaddress-int"><code>cidr</code> now maps to <code>NpgsqlCidr</code> instead of <code>ValueTuple&lt;IPAddress, int&gt;</code></h3>
<p>As part of improving Npgsql's support for the PostgreSQL network mappings (see above), the PostgreSQL <code>cidr</code> type now maps to the newly-introduced <a class="xref" href="../api/NpgsqlTypes.NpgsqlCidr.html">NpgsqlCidr</a>, and can no longer be mapped to <code>ValueTuple&lt;IPAddress, int&gt;</code>.</p>
<h3 id="obsoletions-and-obsolete-api-removals">Obsoletions and obsolete API removals</h3>
<ul>
<li><code>NpgsqlTsVector.Parse()</code> and <code>NpgsqlTsQuery.Parse()</code> are now obsolete. These methods attempted to mimic the behavior of the PostgreSQL <code>to_tsvector</code> and <code>to_tsquery</code> functions, but could only do so partially and in problematic ways. Use the PostgreSQL functions instead.</li>
<li>The parsing functions on the built-in geometry types (NpgsqlPoint, NpgsqlBox etc.) have been removed; similarly, they partially replicated PostgreSQL parsing functionality client-side and had issues.</li>
<li><code>NpgsqlLargeObjectManager</code> and <code>NpsgqlLargeObjectStream</code> are now obsolete. These types were very rarely-used, provided only a thin wrapper over easily-accessible PostgreSQL large-object functions, and limited usage in various ways (e.g. they didn't allow batching). Call the PostgreSQL large-object functions directly.</li>
<li>The <code>Internal Command Timeout</code> connection string parameter has been obsoleted.</li>
<li><code>NpgsqlDbType.TimestampTZ</code> and <code>NpgsqlDbType.TimeTZ</code> were obsoleted many releases ago, and were finally removed. Use <code>NpgsqlDbType.TimestampTz</code> and <code>NpgsqlDbType.TimeTz</code> instead.</li>
</ul>
<h3 id="executing-a-void-returning-function-returns-net-null-instead-of-dbnull">Executing a void-returning function returns .NET null instead of DBNull</h3>
<p>Previously, executing a void-returning returned <code>DBNull.Value</code>:</p>
<pre><code class="lang-c#">var command = new NpgsqlCommand(&quot;SELECT pg_sleep(10)&quot;, connection);
var result = await command.ExecuteScalarAsync();
</code></pre>
<p>Before 8.0, <code>result</code> had the value <code>DBNull.Value</code>; this has been changed in 8.0 to be .NET <code>null</code>. This is more correct (as there are no results, rather than a result containing NULL), aligns with ADO.NET standard practices and with other drivers.</p>
<h3 id="plugin-apis-have-been-changed-for-nativeaottrimming-support">Plugin APIs have been changed for NativeAOT/trimming support</h3>
<p>As part of the effort to make Npgsql compatible with NativeAOT and trimming, the plugin API was changed in fundamental, breaking ways. Although this API never had the stability guarantees of a true public API (it was and still is in an Internal namespace), external plugins which were developed with it will require adjustments.</p>
<h2 id="contributors">Contributors</h2>
<p>Thank you very much to the following people who have contributed to the individual 8.0.x. releases.</p>
<h3 id="milestone-800"><a href="https://github.com/Npgsql/Npgsql/issues?q=is%3Aissue+milestone%3A8.0.0">Milestone 8.0.0</a></h3>
<table>
<thead>
<tr>
<th>Contributor</th>
<th style="text-align: right;">Assigned issues</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/NinoFloris">@NinoFloris</a></td>
<td style="text-align: right;"><a href="https://github.com/Npgsql/Npgsql/issues?q=is%3Aissue+milestone%3A8.0.0+is%3Aclosed+assignee%3ANinoFloris">43</a></td>
</tr>
<tr>
<td><a href="https://github.com/vonzshik">@vonzshik</a></td>
<td style="text-align: right;"><a href="https://github.com/Npgsql/Npgsql/issues?q=is%3Aissue+milestone%3A8.0.0+is%3Aclosed+assignee%3Avonzshik">23</a></td>
</tr>
<tr>
<td><a href="https://github.com/roji">@roji</a></td>
<td style="text-align: right;"><a href="https://github.com/Npgsql/Npgsql/issues?q=is%3Aissue+milestone%3A8.0.0+is%3Aclosed+assignee%3Aroji">20</a></td>
</tr>
<tr>
<td><a href="https://github.com/manandre">@manandre</a></td>
<td style="text-align: right;"><a href="https://github.com/Npgsql/Npgsql/issues?q=is%3Aissue+milestone%3A8.0.0+is%3Aclosed+assignee%3Amanandre">4</a></td>
</tr>
<tr>
<td><a href="https://github.com/BogdanYarotsky">@BogdanYarotsky</a></td>
<td style="text-align: right;"><a href="https://github.com/Npgsql/Npgsql/issues?q=is%3Aissue+milestone%3A8.0.0+is%3Aclosed+assignee%3ABogdanYarotsky">1</a></td>
</tr>
<tr>
<td><a href="https://github.com/Brar">@Brar</a></td>
<td style="text-align: right;"><a href="https://github.com/Npgsql/Npgsql/issues?q=is%3Aissue+milestone%3A8.0.0+is%3Aclosed+assignee%3ABrar">1</a></td>
</tr>
<tr>
<td><a href="https://github.com/erikdesj">@erikdesj</a></td>
<td style="text-align: right;"><a href="https://github.com/Npgsql/Npgsql/issues?q=is%3Aissue+milestone%3A8.0.0+is%3Aclosed+assignee%3Aerikdesj">1</a></td>
</tr>
<tr>
<td><a href="https://github.com/SoftStoneDevelop">@SoftStoneDevelop</a></td>
<td style="text-align: right;"><a href="https://github.com/Npgsql/Npgsql/issues?q=is%3Aissue+milestone%3A8.0.0+is%3Aclosed+assignee%3ASoftStoneDevelop">1</a></td>
</tr>
<tr>
<td><a href="https://github.com/sonquer">@sonquer</a></td>
<td style="text-align: right;"><a href="https://github.com/Npgsql/Npgsql/issues?q=is%3Aissue+milestone%3A8.0.0+is%3Aclosed+assignee%3Asonquer">1</a></td>
</tr>
<tr>
<td><a href="https://github.com/yucelkivanc-hepsiburada">@yucelkivanc-hepsiburada</a></td>
<td style="text-align: right;"><a href="https://github.com/Npgsql/Npgsql/issues?q=is%3Aissue+milestone%3A8.0.0+is%3Aclosed+assignee%3Ayucelkivanc-hepsiburada">1</a></td>
</tr>
</tbody>
</table>
</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/npgsql/doc/blob/main/conceptual/Npgsql/release-notes/8.0.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      © Copyright 2024 The Npgsql Development Team
      
          </div>
        </div>
      </footer>
    </div>

    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
