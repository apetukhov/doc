<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Build Server Notes | Npgsql Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Build Server Notes | Npgsql Documentation ">
      
      
      <link rel="icon" href="../favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://github.com/npgsql/doc/blob/main/dev/build-server.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="page" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">


<p>This page describes the steps used to set up the Npgsql build server.</p>
<p>If you're upgrading the TeamCity version, see &quot;Give agent service start/stop permissions&quot; below.</p>
<h2 id="install-all-supported-versions-of-the-postgresql-backend">Install all supported versions of the Postgresql backend</h2>
<p>At the time of writing, this means 9.1, 9.2, 9.3, 9.4, 9.5. They are configured on ports 5491, 5492, 5493, 5494, 5495.</p>
<p>For SSPI/GSS tests, you need to set up a user with the same name as the user that will be running the tests (i.e. teamcity_agent).
You must also add the following lines at the top of each PG's pg_hba.conf to set up SSPI/GSS for that user:</p>
<pre><code>host    all             teamcity_agent  127.0.0.1/32            sspi  include_realm=0
host    all             teamcity_agent  ::1/128                 sspi  include_realm=0
</code></pre>
<p>See <a href="https://wiki.postgresql.org/wiki/Configuring_for_single_sign-on_using_SSPI_on_Windows">this page on SSPI</a>.</p>
<h2 id="install-a-teamcity-dedicated-postgresql-cluster">Install a TeamCity-dedicated Postgresql cluster</h2>
<p>TeamCity itself requires an SQL database, but we don't want it to run in the same environment as that used for the unit tests. So choosing the latest stable Postgresql version (9.6 at time of writing), we create a new Postgresql cluster: <code>initdb -U postgres -W c:\dev\TeamcityPostgresData</code></p>
<p>Next we set up a Windows service that starts up the new cluster: <code>pg_ctl register -N postgresql-9.6-teamcity -U teamcity -P &lt;password&gt; -D c:\dev\TeamcityPostgresData</code></p>
<p>Finally, create a a user and database and point TeamCity to it.</p>
<h2 id="install-net-sdks-for-all-supported-net-versions">Install .NET SDKs for all supported .NET versions</h2>
<ul>
<li>.NET 4.0 (Windows 7 SDK): <a href="http://www.microsoft.com/en-us/download/details.aspx?id=8279">http://www.microsoft.com/en-us/download/details.aspx?id=8279</a></li>
<li>.NET 4.5 (Windows 8 SDK): <a href="http://msdn.microsoft.com/en-us/windows/hardware/hh852363.aspx">http://msdn.microsoft.com/en-us/windows/hardware/hh852363.aspx</a></li>
<li>.NET 4.5.1 (Windows 8.1 SDK): <a href="http://msdn.microsoft.com/en-us/windows/hardware/bg162891.aspx">http://msdn.microsoft.com/en-us/windows/hardware/bg162891.aspx</a></li>
</ul>
<p>While installing the SDK for .NET 4.0, I had this problem: <a href="http://support.microsoft.com/kb/2717426">http://support.microsoft.com/kb/2717426</a></p>
<h2 id="give-agent-service-startstop-permissions">Give agent service start/stop permissions</h2>
<p>When upgrading TeamCity, the agent needs to be able to stop and start the Windows service. This is how you can grant a normal user specific permissions on specific services:</p>
<ul>
<li>Download and install subinacl from <a href="http://www.microsoft.com/en-us/download/details.aspx?id=23510">http://www.microsoft.com/en-us/download/details.aspx?id=23510</a></li>
<li>cd C:\Program Files (x86)\Windows Resource Kits\Tools\</li>
<li>subinacl /service TCBuildAgent /grant=teamcity_agent=TO</li>
</ul>
<h2 id="update-build-status-back-in-github">Update build status back in github</h2>
<ul>
<li>Download the plugin from <a href="https://github.com/jonnyzzz/TeamCity.GitHub">https://github.com/jonnyzzz/TeamCity.GitHub</a>, get the ZIP</li>
<li>Drop the ZIP in the TeamCity content dir's plugins subdir</li>
<li>Add the Build Feature &quot;Report change status to GitHub&quot;. Configure everything appropriately, and be sure the user you set up has push access to the repository!</li>
</ul>
<h2 id="install-assorted-dev-utilities">Install assorted dev utilities</h2>
<ul>
<li>GitVersion (with Chocolatey)</li>
<li>WiX toolset (v3.10.1 at time of writing)</li>
</ul>
<h2 id="install-wix">Install WiX</h2>
<p>WiX 3.10 has a dependency on .NET Framework 3.5, but there's some issue blocking its installation on Windows Server 2012 R2 (at least on Azure).
A good workaround is to simply install via Powershell (<code>Add-WindowsFeature NET-Framework-Core</code>), see
<a href="https://msdn.microsoft.com/en-us/library/dn169001(v=nav.70).aspx#InstallNET35">https://msdn.microsoft.com/en-us/library/dn169001(v=nav.70).aspx#InstallNET35</a>.</p>
<p>Note that ICE validation is disabled because apparently it requires an interactive account or admin privileges, which doesn't work in continuous integration.</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/npgsql/doc/blob/main/dev/build-server.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          © Copyright 2024 The Npgsql Development Team
        </div>
      </div>
    </footer>
  </body>
</html>
