<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Full Text Search | Npgsql Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Full Text Search | Npgsql Documentation ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/npgsql/doc/blob/main/conceptual/EFCore.PG/mapping/full-text-search.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../img/logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="full-text-search">Full Text Search</h1>

<p>PostgreSQL has <a href="https://www.postgresql.org/docs/current/static/textsearch.html">built-in support for full-text search</a>, which allows you to conveniently and efficiently query natural language documents.</p>
<h2 id="mapping">Mapping</h2>
<p>PostgreSQL full text search types are mapped onto .NET types built-in to Npgsql. The <code>tsvector</code> type is mapped to <code>NpgsqlTsVector</code> and <code>tsquery</code> is mapped to <code>NpgsqlTsQuery</code>. This means you can use properties of type <code>NpgsqlTsVector</code> directly in your model to create <code>tsvector</code> columns. The <code>NpgsqlTsQuery</code> type on the other hand, is used in LINQ queries.</p>
<pre><code class="lang-csharp">public class Product
{
    public int Id { get; set; }
    public string Title { get; set; }
    public string Description { get; set; }
    public NpgsqlTsVector SearchVector { get; set; }
}
</code></pre>
<h2 id="setting-up-and-querying-a-full-text-search-index-on-an-entity">Setting up and querying a full text search index on an entity</h2>
<p><a href="https://www.postgresql.org/docs/current/static/textsearch-tables.html">As the PostgreSQL documentation explains</a>, full-text search requires an index to run efficiently. This section will show two ways to do this, each having its benefits and drawbacks. Please read the PostgreSQL docs for more information on the two different approaches.</p>
<h3 id="method-1-tsvector-column">Method 1: tsvector column</h3>
<p>This method adds a <code>tsvector</code> column to your table, that is automatically updated when the row is modified. First, add an <code>NpgsqlTsVector</code> property to your entity:</p>
<pre><code class="lang-csharp">public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Description { get; set; }
    public NpgsqlTsVector SearchVector { get; set; }
}
</code></pre>
<p>Setting up the column to be auto-updated depends on your PostgreSQL version. On PostgreSQL 12 and above, the column can be a simple <a href="../modeling/generated-properties.html#computed-columns">generated column</a>, and version 5.0.0 contains sugar for setting that up. In previous versions, you must manually set up database triggers that update the column instead.</p>
<div class="tabGroup" id="tabgroup_1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_1_pg12" role="tab" aria-controls="tabpanel_1_pg12" data-tab="pg12" tabindex="0" aria-selected="true">PostgreSQL 12+</a>
</li>
<li role="presentation">
<a href="#tabpanel_1_pg-lt-12" role="tab" aria-controls="tabpanel_1_pg-lt-12" data-tab="pg-lt-12" tabindex="-1">Older Versions</a>
</li>
</ul>
<section id="tabpanel_1_pg12" role="tabpanel" data-tab="pg12">

<div class="NOTE">
<h5>Note</h5>
<p>The below only works on PostgreSQL 12 and version 5.0.0 of the EF Core provider.</p>
</div>
<p>The following will set up a generated <code>tsvector</code> column, over which you can easily create an index:</p>
<pre><code class="lang-csharp">protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder.Entity&lt;Product&gt;()
        .HasGeneratedTsVectorColumn(
            p =&gt; p.SearchVector,
            &quot;english&quot;,  // Text search config
            p =&gt; new { p.Name, p.Description })  // Included properties
        .HasIndex(p =&gt; p.SearchVector)
        .HasMethod(&quot;GIN&quot;); // Index method on the search vector (GIN or GIST)
}
</code></pre>
</section>
<section id="tabpanel_1_pg-lt-12" role="tabpanel" data-tab="pg-lt-12" aria-hidden="true" hidden="hidden">

<p>First, modify the <code>OnModelCreating()</code> of your context class to add an index as follows:</p>
<pre><code class="lang-csharp">protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder.Entity&lt;Product&gt;()
        .HasIndex(p =&gt; p.SearchVector)
        .HasMethod(&quot;GIN&quot;); // Index method on the search vector (GIN or GIST)
}
</code></pre>
<p>Now generate a migration (<code>dotnet ef migrations add ....</code>), and open it with your favorite editor, adding the following:</p>
<pre><code class="lang-csharp">public partial class CreateProductTable : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        // Migrations for creation of the column and the index will appear here, all we need to do is set up the trigger to update the column:

        migrationBuilder.Sql(
            @&quot;CREATE TRIGGER product_search_vector_update BEFORE INSERT OR UPDATE
              ON &quot;&quot;Products&quot;&quot; FOR EACH ROW EXECUTE PROCEDURE
              tsvector_update_trigger(&quot;&quot;SearchVector&quot;&quot;, 'pg_catalog.english', &quot;&quot;Name&quot;&quot;, &quot;&quot;Description&quot;&quot;);&quot;);

        // If you were adding a tsvector to an existing table, you should populate the column using an UPDATE
        // migrationBuilder.Sql(&quot;UPDATE \&quot;Products\&quot; SET \&quot;Name\&quot; = \&quot;Name\&quot;;&quot;);
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        // Migrations for dropping of the column and the index will appear here, all we need to do is drop the trigger:
        migrationBuilder.Sql(&quot;DROP TRIGGER product_search_vector_update&quot;);
    }
}
</code></pre>
</section>
</div>

<p>Once your auto-updated <code>tsvector</code> column is set up, any inserts or updates on the <code>Products</code> table will now update the <code>SearchVector</code> column and maintain it automatically. You can query it as follows:</p>
<pre><code class="lang-csharp">var context = new ProductDbContext();
var npgsql = context.Products
    .Where(p =&gt; p.SearchVector.Matches(&quot;Npgsql&quot;))
    .ToList();
</code></pre>
<h3 id="method-2-expression-index">Method 2: Expression index</h3>
<p>Version 5.0.0 of the provider includes sugar for defining the appropriate expression index; if you're using an older version, you'll have to define a raw SQL migration yourself.</p>
<div class="tabGroup" id="tabgroup_2">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_2_v5" role="tab" aria-controls="tabpanel_2_v5" data-tab="v5" tabindex="0" aria-selected="true">Version 5.0.0</a>
</li>
<li role="presentation">
<a href="#tabpanel_2_lt-v5" role="tab" aria-controls="tabpanel_2_lt-v5" data-tab="lt-v5" tabindex="-1">Older Versions</a>
</li>
</ul>
<section id="tabpanel_2_v5" role="tabpanel" data-tab="v5">

<pre><code class="lang-csharp">modelBuilder.Entity&lt;Blog&gt;()
    .HasIndex(b =&gt; new { b.Title, b.Description })
    .HasMethod(&quot;GIN&quot;)
    .IsTsVectorExpressionIndex(&quot;english&quot;);
</code></pre>
</section>
<section id="tabpanel_2_lt-v5" role="tabpanel" data-tab="lt-v5" aria-hidden="true" hidden="hidden">

<p>Create a migration which will contain the index creation SQL (<code>dotnet ef migrations add ...</code>). At this point, open the generated migration with your editor and add the following:</p>
<pre><code class="lang-csharp">protected override void Up(MigrationBuilder migrationBuilder)
{
    migrationBuilder.Sql(@&quot;CREATE INDEX fts_idx ON &quot;&quot;Product&quot;&quot; USING GIN (to_tsvector('english', &quot;&quot;Name&quot;&quot; || ' ' || &quot;&quot;Description&quot;&quot;));&quot;);
}

protected override void Down(MigrationBuilder migrationBuilder)
    migrationBuilder.Sql(@&quot;DROP INDEX fts_idx;&quot;);
}
</code></pre>
</section>
</div>

<p>Once the index is created on the <code>Title</code> and <code>Description</code> columns, you can query as follows:</p>
<pre><code class="lang-csharp">var context = new ProductDbContext();
var npgsql = context.Products
    .Where(p =&gt; EF.Functions.ToTsVector(&quot;english&quot;, p.Title + &quot; &quot; + p.Description)
        .Matches(&quot;Npgsql&quot;))
    .ToList();
</code></pre>
<h2 id="computed-column-over-json-columns">Computed column over JSON columns</h2>
<p>Starting with 7.0, the provider can also create computed <code>tsvector</code> columns over JSON columns. Simply use <code>HasGeneratedTsVectorColumn()</code> as shown above, and when applied to JSON columns, the provider will automatically generate <a href="https://www.postgresql.org/docs/current/functions-textsearch.html#TEXTSEARCH-FUNCTIONS-TABLE"><code>json_to_tsvector/jsonb_to_tsvector</code></a> as appropriate.</p>
<p>Note that this will pass the filter <code>all</code> to these functions, meaning that all values in the JSON document will be included. To customize the filter - or to create the computed column on older versions of the provider - simply specify the function yourself via <a href="https://docs.microsoft.com/ef/core/modeling/generated-properties?tabs=data-annotations#computed-columns"><code>HasComputedColumnSql</code></a>.</p>
<h2 id="operation-translation">Operation translation</h2>
<p>Almost all PostgreSQL full text search functions can be called through LINQ queries. All supported EF Core LINQ methods are defined in extension classes in the <code>Microsoft.EntityFrameworkCore</code> namespace, so simply referencing the Npgsql provider will light up these methods. The following table lists all supported operations; if an operation you need is missing, please open an issue to request for it.</p>
<table>
<thead>
<tr>
<th>.NET</th>
<th>SQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>EF.Functions.ToTsVector(string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html#TEXTSEARCH-PARSING-DOCUMENTS">to_tsvector(string)</a></td>
</tr>
<tr>
<td>EF.Functions.ToTsVector(&quot;english&quot;, string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html#TEXTSEARCH-PARSING-DOCUMENTS">to_tsvector('english'::regconfig, string)</a></td>
</tr>
<tr>
<td>EF.Functions.ToTsQuery(string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html#TEXTSEARCH-PARSING-QUERIES">to_tsquery(string)</a></td>
</tr>
<tr>
<td>EF.Functions.ToTsQuery(&quot;english&quot;, string )</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html#TEXTSEARCH-PARSING-QUERIES">to_tsquery('english'::regconfig, string)</a></td>
</tr>
<tr>
<td>EF.Functions.PlainToTsQuery(string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html#TEXTSEARCH-PARSING-QUERIES">plainto_tsquery(string)</a></td>
</tr>
<tr>
<td>EF.Functions.PlainToTsQuery(&quot;english&quot;, string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html#TEXTSEARCH-PARSING-QUERIES">plainto_tsquery('english'::regconfig, string)</a></td>
</tr>
<tr>
<td>EF.Functions.PhraseToTsQuery(string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html#TEXTSEARCH-PARSING-QUERIES">phraseto_tsquery(string)</a></td>
</tr>
<tr>
<td>EF.Functions.PhraseToTsQuery(&quot;english&quot;, string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html#TEXTSEARCH-PARSING-QUERIES">phraseto_tsquery('english'::regconfig, string)</a></td>
</tr>
<tr>
<td>EF.Functions.WebSearchToTsQuery(string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html#TEXTSEARCH-PARSING-QUERIES">websearch_to_tsquery(string)</a></td>
</tr>
<tr>
<td>EF.Functions.WebSearchToTsQuery(&quot;english&quot;, string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html#TEXTSEARCH-PARSING-QUERIES">websearch_to_tsquery('english'::regconfig, string)</a></td>
</tr>
<tr>
<td>EF.functions.ArrayToTsVector(new[] { &quot;a&quot;, &quot;b&quot; })</td>
<td><a href="https://www.postgresql.org/docs/current/functions-textsearch.html#TEXTSEARCH-FUNCTIONS-TABLE">array_to_tsvector(ARRAY['a', 'b'])</a></td>
</tr>
<tr>
<td>NpgsqlTsVector.Parse(string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/sql-expressions.html#SQL-SYNTAX-TYPE-CASTS">CAST(string AS tsvector)</a></td>
</tr>
<tr>
<td>NpgsqlTsQuery.Parse(string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/sql-expressions.html#SQL-SYNTAX-TYPE-CASTS">CAST(queryString AS tsquery)</a></td>
</tr>
<tr>
<td>tsvector.Matches(string)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-intro.html#TEXTSEARCH-MATCHING">tsvector @@ plainto_tsquery(string)</a></td>
</tr>
<tr>
<td>tsvector.Matches(tsquery)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html#TEXTSEARCH-PARSING-QUERIES">tsvector @@ tsquery</a></td>
</tr>
<tr>
<td>tsquery1.And(tsquery2)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-features.html#TEXTSEARCH-MANIPULATE-TSQUERY">tsquery1 &amp;&amp; tsquery2</a></td>
</tr>
<tr>
<td>tsquery1.Or(tsquery2)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-features.html#TEXTSEARCH-MANIPULATE-TSQUERY">tsquery1 || tsquery2</a></td>
</tr>
<tr>
<td>tsquery.ToNegative()</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-features.html#TEXTSEARCH-MANIPULATE-TSQUERY">!! tsquery</a></td>
</tr>
<tr>
<td>tsquery1.Contains(tsquery2)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-features.html#TEXTSEARCH-MANIPULATE-TSQUERY">tsquery1 @&gt; tsquery2</a></td>
</tr>
<tr>
<td>tsquery1.IscontainedIn(tsquery2)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-features.html#TEXTSEARCH-MANIPULATE-TSQUERY">tsquery1 &lt;@ tsquery2</a></td>
</tr>
<tr>
<td>tsquery.GetNodeCount()</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-features.html#TEXTSEARCH-MANIPULATE-TSQUERY">numnode(query)</a></td>
</tr>
<tr>
<td>tsquery.GetQueryTree()</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-features.html#TEXTSEARCH-MANIPULATE-TSQUERY">querytree(query)</a></td>
</tr>
<tr>
<td>tsquery.GetResultHeadline(&quot;a b c&quot;)</td>
<td><a href="https://www.postgresql.org/docs/current/textsearch-controls.html#TEXTSEARCH-HEADLINE">ts_headline('a b c', query)</a></td>
</tr>
<tr>
<td>tsquery.GetResultHeadline(&quot;a b c&quot;, &quot;MinWords=1, MaxWords=2&quot;)</td>
<td><a href="https://www.postgresql.org/docs/current/textsearch-controls.html#TEXTSEARCH-HEADLINE">ts_headline('a b c', query, 'MinWords=1, MaxWords=2')</a></td>
</tr>
<tr>
<td>tsquery.Rewrite(targetQuery, substituteQuery)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-textsearch.html#TEXTSEARCH-FUNCTIONS-TABLE">ts_rewrite(to_tsquery(tsquery), to_tsquery(targetQuery), to_tsquery(substituteQuery))</a></td>
</tr>
<tr>
<td>tsquery1.ToPhrase(tsquery2)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-textsearch.html#TEXTSEARCH-FUNCTIONS-TABLE">tsquery_phrase(tsquery1, tsquery2)</a></td>
</tr>
<tr>
<td>tsquery1.ToPhrase(tsquery2, distance)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-textsearch.html#TEXTSEARCH-FUNCTIONS-TABLE">tsquery_phrase(tsquery1, tsquery2, distance)</a></td>
</tr>
<tr>
<td>tsvector1.Concat(tsvector2)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-textsearch.html#TEXTSEARCH-OPERATORS-TABLE">tsvector1 || tsvector2</a></td>
</tr>
<tr>
<td>tsvector.Delete(&quot;x&quot;)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-textsearch.html#TEXTSEARCH-FUNCTIONS-TABLE">ts_delete(tsvector, 'x')</a></td>
</tr>
<tr>
<td>tsvector.Delete(new[] { &quot;x&quot;, &quot;y&quot; })</td>
<td><a href="https://www.postgresql.org/docs/current/functions-textsearch.html#TEXTSEARCH-FUNCTIONS-TABLE">ts_delete(tsvector, ARRAY['x', 'y'])</a></td>
</tr>
<tr>
<td>tsvector.Filter(new[] { &quot;x&quot;, &quot;y&quot; })</td>
<td><a href="https://www.postgresql.org/docs/current/functions-textsearch.html#TEXTSEARCH-FUNCTIONS-TABLE">ts_filter(tsvector, ARRAY['x', 'y'])</a></td>
</tr>
<tr>
<td>tsvector.GetLength()</td>
<td><a href="https://www.postgresql.org/docs/current/functions-textsearch.html#TEXTSEARCH-FUNCTIONS-TABLE">length(tsvector)</a></td>
</tr>
<tr>
<td>tsvector.Rank(tsquery)</td>
<td><a href="https://www.postgresql.org/docs/current/textsearch-controls.html#TEXTSEARCH-RANKING">ts_rank(tsvector, tsquery)</a></td>
</tr>
<tr>
<td>tsvector.RankCoverDensity(tsquery)</td>
<td><a href="https://www.postgresql.org/docs/current/textsearch-controls.html#TEXTSEARCH-RANKING">ts_rank_cd(tsvector, tsquery)</a></td>
</tr>
<tr>
<td>tsvector.SetWeight(NpgsqlTsVector.Lexeme.Weight.A)</td>
<td><a href="https://www.postgresql.org/docs/current/static/textsearch-features.html#TEXTSEARCH-MANIPULATE-TSVECTOR">setweight(tsvector, 'A')</a></td>
</tr>
<tr>
<td>tsvector.ToStripped()</td>
<td><a href="https://www.postgresql.org/docs/current/functions-textsearch.html#TEXTSEARCH-FUNCTIONS-TABLE">strip(tsvector)</a></td>
</tr>
<tr>
<td>EF.Functions.Unaccent(string)</td>
<td><a href="https://www.postgresql.org/docs/current/unaccent.html">unaccent(string)</a></td>
</tr>
<tr>
<td>EF.Functions.Unaccent(regdictionary, string)</td>
<td><a href="https://www.postgresql.org/docs/current/unaccent.html">unaccent(regdictionary, string)</a></td>
</tr>
</tbody>
</table>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/npgsql/doc/blob/main/conceptual/EFCore.PG/mapping/full-text-search.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          © Copyright 2024 The Npgsql Development Team
        </div>
      </div>
    </footer>
  </body>
</html>
