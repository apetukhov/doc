<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Date/Time Mapping with NodaTime | Npgsql Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Date/Time Mapping with NodaTime | Npgsql Documentation ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/npgsql/doc/blob/main/conceptual/EFCore.PG/mapping/nodatime.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="datetime-mapping-with-nodatime">Date/Time Mapping with NodaTime</h1>

<h2 id="what-is-nodatime">What is NodaTime</h2>
<p>By default, <a href="https://www.postgresql.org/docs/current/static/datatype-datetime.html">the PostgreSQL date/time types</a> are mapped to the built-in .NET types (<code>DateTime</code>, <code>TimeSpan</code>). Unfortunately, these built-in types are flawed in many ways. The <a href="http://nodatime.org/">NodaTime library</a> was created to solve many of these problems, and if your application handles dates and times in anything but the most basic way, you should consider using it. To learn more <a href="http://blog.nodatime.org/2011/08/what-wrong-with-datetime-anyway.html">read this blog post by Jon Skeet</a>.</p>
<p>Beyond NodaTime's general advantages, some specific advantages NodaTime for PostgreSQL date/time mapping include:</p>
<ul>
<li>NodaTime defines some types which are missing from the BCL, such as <code>LocalDate</code>, <code>LocalTime</code>, and <code>OffsetTime</code>. These cleanly correspond to PostgreSQL <code>date</code>, <code>time</code> and <code>timetz</code>.</li>
<li><code>Period</code> is much more suitable for mapping PostgreSQL <code>interval</code> than <code>TimeSpan</code>.</li>
<li>NodaTime types can fully represent PostgreSQL's microsecond precision, and can represent dates outside the BCL's date limit (1AD-9999AD).</li>
</ul>
<h2 id="setup">Setup</h2>
<p>To set up the NodaTime plugin, add the <a href="https://www.nuget.org/packages/Npgsql.EntityFrameworkCore.PostgreSQL.NodaTime">Npgsql.EntityFrameworkCore.PostgreSQL.NodaTime nuget</a> to your project. Then, configure the NodaTime plugin as follows:</p>
<div class="tabGroup" id="tabgroup_1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_1_ef9-with-connection-string" role="tab" aria-controls="tabpanel_1_ef9-with-connection-string" data-tab="ef9-with-connection-string" tabindex="0" aria-selected="true">EF 9.0, with a connection string</a>
</li>
<li role="presentation">
<a href="#tabpanel_1_with-datasource" role="tab" aria-controls="tabpanel_1_with-datasource" data-tab="with-datasource" tabindex="-1">With an external NpgsqlDataSource</a>
</li>
<li role="presentation">
<a href="#tabpanel_1_legacy-with-connection-string" role="tab" aria-controls="tabpanel_1_legacy-with-connection-string" data-tab="legacy-with-connection-string" tabindex="-1">Older EF versions, with a connection string</a>
</li>
</ul>
<section id="tabpanel_1_ef9-with-connection-string" role="tabpanel" data-tab="ef9-with-connection-string">

<p>If you're passing a connection string to <code>UseNpgsql</code>, simply add the <code>UseNodaTime</code> call as follows:</p>
<pre><code class="lang-c#">builder.Services.AddDbContext&lt;MyContext&gt;(options =&gt; options.UseNpgsql(
    &quot;&lt;connection string&gt;&quot;,
    o =&gt; o.UseNodaTime()));
</code></pre>
<p>This configures all aspects of Npgsql to use the NodaTime plugin - both at the EF and the lower-level Npgsql layer.</p>
</section>
<section id="tabpanel_1_with-datasource" role="tabpanel" data-tab="with-datasource" aria-hidden="true" hidden="hidden">

<p>If you're creating an external NpgsqlDataSource and passing it to <code>UseNpgsql</code>, you must call <code>UseNodaTime</code> on your NpgsqlDataSourceBuilder independently of the EF-level setup:</p>
<pre><code class="lang-c#">var dataSourceBuilder = new NpgsqlDataSourceBuilder(&quot;&lt;connection string&gt;&quot;);
dataSourceBuilder.UseNodaTime();
var dataSource = dataSourceBuilder.Build();

builder.Services.AddDbContext&lt;MyContext&gt;(options =&gt; options.UseNpgsql(
    dataSource,
    o =&gt; o.UseNodaTime()));
</code></pre>
</section>
<section id="tabpanel_1_legacy-with-connection-string" role="tabpanel" data-tab="legacy-with-connection-string" aria-hidden="true" hidden="hidden">

<pre><code class="lang-c#">// Configure UseNodaTime at the ADO.NET level.
// This code must be placed at the beginning of your application, before any other Npgsql API is called; an appropriate place for this is in the static constructor on your DbContext class:
static MyDbContext()
    =&gt; NpgsqlConnection.GlobalTypeMapper.UseNodaTime();

// Then, when configuring EF Core with UseNpgsql(), call UseNodaTime():
builder.Services.AddDbContext&lt;MyContext&gt;(options =&gt;
    options.UseNpgsql(&quot;&lt;connection string&gt;&quot;, o =&gt; o.UseNodaTime()));
</code></pre>
</section>
</div>

<p>The above sets up all the necessary mappings and operation translators. You can now use NodaTime types as regular properties in your entities, and even perform some operations:</p>
<pre><code class="lang-c#">public class Post
{
    public int Id { get; set; }
    public string Name { get; set; }
    public Instant CreationTime { get; set; }
}

var recentPosts = context.Posts.Where(p =&gt; p.CreationTime &gt; someInstant);
</code></pre>
<h2 id="operation-translation">Operation translation</h2>
<p>The provider knows how to translate many members and methods on mapped NodaTime types. For example, the following query will be translated to SQL and evaluated server-side:</p>
<pre><code class="lang-c#">// Get all events which occurred on a Monday
var mondayEvents = context.Events.Where(p =&gt; p.SomeDate.DayOfWeek == DayOfWeek.Monday);

// Get all events which occurred before the year 2000
var oldEvents = context.Events.Where(p =&gt; p.SomeDate.Year &lt; 2000);
</code></pre>
<p>Following is the list of supported NodaTime translations; If an operation you need is missing, please open an issue to request for it.</p>
<div class="NOTE">
<h5>Note</h5>
<p>Most translations on ZonedDateTime and Period were added in version 6.0</p>
</div>
<table>
<thead>
<tr>
<th>.NET</th>
<th>SQL</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>SystemClock.Instance.GetCurrentInstant()</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">now()</a></td>
<td></td>
</tr>
<tr>
<td>LocalDateTime.Date</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_trunc('day', timestamp)</a></td>
<td></td>
</tr>
<tr>
<td>LocalDateTime.Second (also LocalTime, ZonedDateTime)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('second', timestamp)::INT</a></td>
<td></td>
</tr>
<tr>
<td>LocalDateTime.Minute (also LocalTime, ZonedDateTime)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('minute', timestamp)::INT</a></td>
<td></td>
</tr>
<tr>
<td>LocalDateTime.Hour (also LocalTime, ZonedDateTime)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('hour', timestamp)::INT</a></td>
<td></td>
</tr>
<tr>
<td>LocalDateTime.Day, (also LocalDate, ZonedDateTime)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('day', timestamp)::INT</a></td>
<td></td>
</tr>
<tr>
<td>LocalDateTime.Month (also LocalDate, ZonedDateTime)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('month', timestamp)::INT</a></td>
<td></td>
</tr>
<tr>
<td>LocalDateTime.Year (also LocalDate, ZonedDateTime)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('year', timestamp)::INT</a></td>
<td></td>
</tr>
<tr>
<td>LocalDateTime.DayOfWeek (also LocalDate, ZonedDateTime)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">floor(date_part('dow', timestamp))::INT</a></td>
<td></td>
</tr>
<tr>
<td>LocalDateTime.DayOfYear (also LocalDate, ZonedDateTime)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('doy', timestamp)::INT</a></td>
<td></td>
</tr>
<tr>
<td>Period.Seconds (also Duration)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('second', interval)::INT</a></td>
<td></td>
</tr>
<tr>
<td>Period.Minutes (also Duration)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('minute', interval)::INT</a></td>
<td></td>
</tr>
<tr>
<td>Period.Hours (also Duration)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('hour', interval)::INT</a></td>
<td></td>
</tr>
<tr>
<td>Period.Days (also Duration)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('day', interval)::INT</a></td>
<td></td>
</tr>
<tr>
<td>Period.Months</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('month', interval)::INT</a></td>
<td></td>
</tr>
<tr>
<td>Period.Years</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('year', interval)::INT</a></td>
<td></td>
</tr>
<tr>
<td>Period.FromSeconds</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">make_interval(seconds =&gt; int)</a></td>
<td></td>
</tr>
<tr>
<td>Period.FromMinutes</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">make_interval(minutes =&gt; int)</a></td>
<td></td>
</tr>
<tr>
<td>Period.FromHours</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">make_interval(hours =&gt; int)</a></td>
<td></td>
</tr>
<tr>
<td>Period.FromDays</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">make_interval(days =&gt; int)</a></td>
<td></td>
</tr>
<tr>
<td>Period.FromWeeks</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">make_interval(weeks =&gt; int)</a></td>
<td></td>
</tr>
<tr>
<td>Period.FromMonths</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">make_interval(months =&gt; int)</a></td>
<td></td>
</tr>
<tr>
<td>Period.FromYears</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">make_interval(years =&gt; int)</a></td>
<td></td>
</tr>
<tr>
<td>Duration.TotalMilliseconds</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('epoch', interval) / 0.001</a></td>
<td></td>
</tr>
<tr>
<td>Duration.TotalSeconds</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('epoch', interval)</a></td>
<td></td>
</tr>
<tr>
<td>Duration.TotalMinutes</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('epoch', interval) / 60.0</a></td>
<td></td>
</tr>
<tr>
<td>Duration.TotalDays</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('epoch', interval) / 86400.0</a></td>
<td></td>
</tr>
<tr>
<td>Duration.TotalHours</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html">date_part('epoch', interval) / 3600.0</a></td>
<td></td>
</tr>
<tr>
<td>ZonedDateTime.LocalDateTime</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-ZONECONVERT">timestamptz AT TIME ZONE 'UTC'</a></td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>DateInterval.Length</td>
<td><a href="https://www.postgresql.org/docs/current/functions-range.html">upper(daterange) - lower(daterange)</a></td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>DateInterval.Start</td>
<td><a href="https://www.postgresql.org/docs/current/functions-range.html">lower(daterange)</a></td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>DateInterval.End</td>
<td><a href="https://www.postgresql.org/docs/current/functions-range.html">upper(daterange) - INTERVAL 'P1D'</a></td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>DateInterval.Contains(LocalDate)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-range.html">daterange @&gt; date</a></td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>DateInterval.Contains(DateInterval)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-range.html">daterange @&gt; daterange</a></td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>DateInterval.Intersection(DateInterval)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-range.html">daterange * daterange</a></td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>DateInterval.Union(DateInterval)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-range.html">daterange + daterange</a></td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>Instant.InZone(DateTimeZoneProviders.Tzdb[&quot;Europe/Berlin&quot;]).LocalDateTime</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-ZONECONVERT">timestamptz AT TIME ZONE 'Europe/Berlin'</a></td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>LocalDateTime.InZoneLeniently(DateTimeZoneProviders.Tzdb[&quot;Europe/Berlin&quot;]).ToInstant()</td>
<td><a href="https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-ZONECONVERT">timestamp AT TIME ZONE 'Europe/Berlin'</a></td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>ZonedDateTime.ToInstant</td>
<td>No PG operation (.NET-side conversion from ZonedDateTime to Instant only)</td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>Instant.InUtc</td>
<td>No PG operation (.NET-side conversion from Instant to ZonedDateTime only)</td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>Instant.ToDateTimeUtc</td>
<td>No PG operation (.NET-side conversion from Instant to UTC DateTime only)</td>
<td>Added in 6.0</td>
</tr>
<tr>
<td>EF.Functions.Sum(periods)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE">sum(periods)</a></td>
<td>Added in 7.0, see <a href="translations.html#aggregate-functions">Aggregate functions</a>.</td>
</tr>
<tr>
<td>EF.Functions.Sum(durations)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE">sum(durations)</a></td>
<td>Added in 7.0, see <a href="translations.html#aggregate-functions">Aggregate functions</a>.</td>
</tr>
<tr>
<td>EF.Functions.Average(periods)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE">avg(durations)</a></td>
<td>Added in 7.0, see <a href="translations.html#aggregate-functions">Aggregate functions</a>.</td>
</tr>
<tr>
<td>EF.Functions.Average(durations)</td>
<td><a href="https://www.postgresql.org/docs/current/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE">avg(durations)</a></td>
<td>Added in 7.0, see <a href="translations.html#aggregate-functions">Aggregate functions</a>.</td>
</tr>
</tbody>
</table>
<p>In addition to the above, most arithmetic operators are also translated (e.g. LocalDate + Period).</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/npgsql/doc/blob/main/conceptual/EFCore.PG/mapping/nodatime.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          © Copyright 2024 The Npgsql Development Team
        </div>
      </div>
    </footer>
  </body>
</html>
